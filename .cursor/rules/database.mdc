---
description: Правила работы с Supabase и базой данных
globs: ["scripts/**/*.sql", "docs/SETUP_SUPABASE.md", "docs/KB_TECH_DOCS.md"]
alwaysApply: false
---

# Правила работы с базой данных

## Supabase как источник правды

- Supabase - это объективная операционная память системы
- Все транзакционные данные должны храниться в Supabase
- Другие компоненты (AI агенты, n8n, дашборды) - это клиенты Supabase

## Схема данных

- Все изменения схемы должны быть задокументированы
- Используйте миграции для изменения структуры
- Храните SQL миграции в репозитории (в `scripts/setup/migrations/`)

## Безопасность

- Всегда используйте Row Level Security (RLS) для таблиц
- Настройте политики доступа в зависимости от потребностей
- Никогда не используйте service_role key в клиентских приложениях

## Логирование

- Все ошибки должны логироваться в таблицу `errors`
- Используйте структурированные данные в поле `context` (JSONB)
- Отмечайте решенные ошибки полем `resolved`

## Запросы

- Используйте индексы для часто используемых полей
- Оптимизируйте запросы для производительности
- Избегайте N+1 проблем в запросах

## Версионирование

- Версионируйте схему базы данных
- Документируйте все изменения в `docs/KB_TECH_DOCS.md`
- Создавайте резервные копии перед миграциями

## Примеры

```sql
-- Создание таблицы с RLS
CREATE TABLE products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  sku TEXT UNIQUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Включение RLS
ALTER TABLE products ENABLE ROW LEVEL SECURITY;

-- Политика доступа
CREATE POLICY "Allow read access" ON products
  FOR SELECT
  USING (true);
```

## Интеграция

- Используйте REST API для простых операций
- Используйте RPC для сложных операций
- Кэшируйте часто используемые данные на уровне приложения
